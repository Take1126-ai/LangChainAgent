# LangChain CLI Agent
(このREADMEはAIによって生成されています)<br>
<br>
LangChainフレームワークを活用した、ファイル操作、コマンド実行、インターネット検索が可能な対話型AI CLIツール。<br>
`think_tool`を用いた思考と自己批判によりハルシネーション対策を行いつつユーザーの要求に応じた作業・調査等を行う。会話履歴の自動要約機能も備え、長時間の対話でも効率的にコンテキストを維持します。

## 機能

*   **対話型CLIインターフェース**: `Typer` を使用したコマンドラインインターフェースで、AIアシスタントと対話できます。
*   **エージェントの思考と作業管理**:
    *   **`think_tool`**: エージェントの戦略的思考、作業過程の記録、および最終回答の自己評価のために使用されます。これにより、AIは自身の思考プロセスを振り返り、回答の品質を向上させることができます。
    *   **`work_tool`**: エージェントの作業状態（計画、課題、TODOリストなど）を管理するためのツールです。
    *   **`memos`**: 複数ステップのタスクにおける中間調査過程や必要な情報を「作業用メモリ」として記録するために使用されます。不要になった情報は自動的に削除されます。
*   **ファイル・ディレクトリ操作**: ローカルファイルシステムに対する以下の操作が可能です。
    *   `list_directory_contents`: ディレクトリ内容のリスト表示
    *   `read_file`: ファイル内容の読み込み
    *   `write_file`: ファイルへの書き込み
    *   `delete_file`: ファイルの削除
    *   `create_directory`: ディレクトリの作成
    *   `delete_directory`: ディレクトリの削除
    *   `move`: ファイル/ディレクトリの移動・名前変更
    *   `modify_file_content`: ファイル内容の置換
    *   `read_many_files`: 複数ファイル/ディレクトリ内容の読み込み（globパターン対応）
    *   `search_file_content`: ファイル内容の正規表現検索
    *   **補足**: 現在、テキストファイルの読み込みは `raw_bytes.decode('utf-8', errors='replace')` を使用しています。これにより、デコードエラーによるクラッシュを防ぎますが、非UTF-8ファイルでは文字化けが発生する可能性があります。将来的に、より堅牢な文字コード検出と処理を導入する必要があります。
*   **コマンド実行**: シェルコマンドを実行し、その結果を取得できます。ファイルシステムを変更する可能性のあるコマンドにはユーザーの確認が必要です。ツール実行時のエラーは捕捉され、エージェントにフィードバックされるため、エージェントはエラー内容に基づいて自己修正を試みます。
    *   **補足**: 現在、コマンドの標準出力および標準エラー出力は `raw_bytes.decode('utf-8', errors='replace')` を使用してデコードしています。これにより、デコードエラーによるクラッシュを防ぎますが、非UTF-8出力では文字化けが発生する可能性があります。将来的に、より堅牢な文字コード検出と処理を導入する必要があります。
*   **Webコンテンツ取得**: 指定されたURLのコンテンツを直接取得し、文字コードを自動判定してテキスト形式で内容を返します。インターネット検索ツールが提供するスニペット以上の詳細な情報が必要な場合に利用されます。
*   **インターネット検索**: `Tavily` を利用してインターネット検索を行い、結果の要約やスニペットを取得できます。
*   **会話履歴管理**: 会話履歴を保持し、コンテキストを維持します。
    *   **ツールメッセージの扱い**: ツール実行結果は、`ToolMessage`として直接 `chat_history` に追加されます。
    *   **会話履歴の要約**: `src/config.py` で設定された `MAX_CONVERSATION_TURNS` を超える会話履歴は、LLMによって自動的に要約され、最新の `SUMMARY_CONVERSATION_TURNS` 分の会話と要約メッセージが `chat_history` に保持されます。これにより、長時間の対話でも効率的にコンテキストを維持します。
        - **要約境界の調整**: `AIMessage` (ツール呼び出し) とそれに続く `ToolMessage` (ツール結果) のペアが要約境界で分断されることを防ぐため、要約境界を動的に調整するロジックを実装済みです。これにより、ツール実行のコンテキストが維持されます。
*   **内部思考とツール実行状況の可視化**: エージェントの内部思考プロセスやツール実行の状況をリアルタイムでコンソールに出力できます。
*   **ロギング機能**: `DEBUG_MODE` が `True` の場合、エージェントの内部動作に関する詳細なログが `logs/` ディレクトリ内のファイルに自動的に記録されます。これにより、デバッグや問題分析が容易になります。
*   **ユニットテスト**: 主要なファイル操作ツール (`file_operations.py`) およびコマンド実行ツール (`command_execution.py`) に対してユニットテストが実装されており、コードの信頼性が確保されています。

## インストール

1.  リポジトリをクローンします。
    ```bash
    git clone https://github.com/your-repo/LangChainCLIAgent.git
    cd LangChainCLIAgent
    ```
2.  `uv` を使用して依存関係をインストールします。
    ```bash
    uv sync
    ```
3.  環境変数を設定します。`.envsample` を参考に `.env` ファイルを作成し、必要なAPIキーを設定してください。
    ```
    GOOGLE_API_KEY="YOUR_GOOGLE_API_KEY"
    TAVILY_API_KEY="YOUR_TAVILY_API_KEY"
    ```

## 使い方

### 対話モードの開始

```bash
uv run main.py
```

### Webコンテンツの取得例

AIにWebページのコンテンツを取得させるには、以下のように指示します。

```
あなた: https://example.com の内容を取得してください。
```

### 内部思考の表示とデバッグログ

エージェントの内部思考プロセスやツール実行状況をリアルタイムでコンソールに表示するには、`src/config.py` の `WRITE_INNER_THOUGHTS` を `True` に設定してください。

```python
# src/config.py
class Config:
    # ...
    WRITE_INNER_THOUGHTS: bool = True
    # ...
```

設定後、再度 `uv run main.py` を実行すると、エージェントの思考やツール実行の詳細が `INNER_THINK:` プレフィックス付きで表示されます。

より詳細なデバッグ情報（エージェントの状態、プロンプト内容、LLMの生の結果など）をファイルに記録したい場合は、`src/config.py` の `DEBUG_MODE` を `True` に設定してください。ログファイルは `logs/YYYY-MM-DD_HH-MM-SS_UUID.log` の形式で自動的に生成されます。

```python
# src/config.py
class Config:
    # ...
    DEBUG_MODE: bool = True
    # ...
```

## 設定

`src/config.py` ファイルで、エージェントの動作に関する以下の設定を調整できます。

*   **`DEBUG_MODE`**: デバッグモードを有効にするかどうかを制御します (`True` または `False`)。`True` に設定すると、詳細なログが `logs/` ディレクトリ内のファイルに記録されます。
*   **`WRITE_INNER_THOUGHTS`**: エージェントの内部思考プロセスやツール実行状況をリアルタイムでコンソールに出力するかどうかを制御します (`True` または `False`)。
*   **`MAX_CONVERSATION_TURNS`**: 会話履歴がこのターン数を超えた場合に、自動要約を開始します。`0` に設定すると要約機能は無効になります。
*   **`SUMMARY_CONVERSATION_TURNS`**: 会話履歴が要約された後、最新の会話のうち何ターン分を詳細に保持するかを設定します。

## テストの実行

プロジェクトのテストは `pytest` を使用して実行します。

### 全てのテストを実行

```bash
uv run pytest tests/
```

### 特定のテストファイルを実行

```bash
uv run pytest tests/core/test_agent_summary_boundary.py
uv run pytest tests/tools/test_file_operations.py
uv run pytest tests/tools/test_command_execution.py
```

### テスト結果の確認

テストが成功すると、`passed` のメッセージが表示されます。失敗した場合は、詳細なエラーメッセージが表示されます。